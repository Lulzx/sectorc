# Stage 0: Hex Loader - Linux i386 ELF
# Build: grep -v '^\s*#' stage0.hex | sed 's/#.*//' | tr -d ' \n\t' | xxd -r -p > stage0
# Test:  echo "b8 01 00 00 00 bb 2a 00 00 00 cd 80 q" | ./stage0; echo $?

# ELF Header (52 bytes)
7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
02 00 03 00 01 00 00 00 54 80 04 08 34 00 00 00
00 00 00 00 00 00 00 00 34 00 20 00 01 00 00 00
00 00 00 00

# Program Header (32 bytes)
01 00 00 00 00 00 00 00 00 80 04 08 00 80 04 08
00 10 00 00 00 00 02 00 07 00 00 00 00 10 00 00

# Code at 0x54. edi=write ptr, esi=high nibble

bf 00 90 04 08              # 00: mov edi, 0x08049000

# _read: (at 0x05)
6a 00                       # 05: push 0
89 e1                       # 07: mov ecx, esp
31 db                       # 09: xor ebx, ebx
b2 01                       # 0b: mov dl, 1
b8 03 00 00 00              # 0d: mov eax, 3
cd 80                       # 12: int 0x80
58                          # 14: pop eax
85 c0                       # 15: test eax, eax
74 3f                       # 17: jz _exec (0x58)
3c 71                       # 19: cmp al, 'q'
74 3b                       # 1b: je _exec (0x58)
3c 20                       # 1d: cmp al, ' '
74 e4                       # 1f: je _read
3c 0a                       # 21: cmp al, '\n'
74 e0                       # 23: je _read
3c 09                       # 25: cmp al, '\t'
74 dc                       # 27: je _read

# Process first nibble
e8 1f 00 00 00              # 29: call _hex (0x4d)
c1 e0 04                    # 2e: shl eax, 4
89 c6                       # 31: mov esi, eax (save high nibble)

# Read second char
6a 00                       # 33: push 0
89 e1                       # 35: mov ecx, esp
31 db                       # 37: xor ebx, ebx
b2 01                       # 39: mov dl, 1
b8 03 00 00 00              # 3b: mov eax, 3
cd 80                       # 40: int 0x80
58                          # 42: pop eax
e8 05 00 00 00              # 43: call _hex (0x4d)
09 f0                       # 48: or eax, esi
aa                          # 4a: stosb
eb b8                       # 4b: jmp _read (0x05)

# _hex: (at 0x4d) - handles both uppercase and lowercase
3c 39                       # 4d: cmp al, '9'
7e 04                       # 4f: jle _digit (skip to 0x55)
24 df                       # 51: and al, 0xDF (uppercase)
2c 07                       # 53: sub al, 7
2c 30                       # 55: _digit: sub al, '0'
c3                          # 57: ret

# _exec: (at 0x58)
b8 00 90 04 08              # 58: mov eax, 0x08049000
ff e0                       # 5d: jmp eax
